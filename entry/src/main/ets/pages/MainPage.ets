import router from '@ohos.router';
import { Diary } from '../model/DiaryModel';
import { DataManager } from '../manager/DataManager';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';
import { SpeechRecognizer } from '../manager/SpeechRecognizer';
import hilog from '@ohos.hilog';

@Entry
@Component
struct MainPage {
  @State diaryList: Diary[] = [];
  @State filteredList: Diary[] = [];
  @State searchText: string = '';
  @State showSearch: boolean = false;
  @State selectedFilter: string = 'all'; // all, today, week, month
  @State fabScale: number = 1.0;

  private dataManager: DataManager = DataManager.getInstance(getContext(this) as common.UIAbilityContext);
  private isInitialized: boolean = false;

  aboutToAppear() {
    hilog.info(0x0000, 'MainPage', 'aboutToAppear è¢«è°ƒç”¨');
    if (!this.isInitialized) {
      this.initAllServices();
      this.isInitialized = true;
    }
    this.loadDiaryList();
  }

  onPageShow() {
    this.loadDiaryList();
  }

  initAllServices() {
    DataManager.getInstance(getContext(this) as common.UIAbilityContext);
    SpeechRecognizer.getInstance();
  }

  async loadDiaryList() {
    try {
      this.diaryList = await this.dataManager.loadDiaryList();
      // é‡è¦:ç½®é¡¶çš„å§‹ç»ˆæŽ’åœ¨æœ€å‰é¢,ç„¶åŽæŒ‰æ—¶é—´å€’åº
      this.diaryList.sort((a, b) => {
        // å¦‚æžœç½®é¡¶çŠ¶æ€ä¸åŒ,ç½®é¡¶çš„æŽ’å‰é¢
        if (a.isPinned && !b.isPinned) return -1;
        if (!a.isPinned && b.isPinned) return 1;
        // ç½®é¡¶çŠ¶æ€ç›¸åŒ,æŒ‰æ—¶é—´å€’åº
        return b.createTime - a.createTime;
      });
      this.applyFilter();
    } catch (error) {
      this.diaryList = [];
      this.filteredList = [];
    }
  }

  applyFilter() {
    let list = [...this.diaryList];

    // æ—¶é—´è¿‡æ»¤
    const now = Date.now();
    const oneDayMs = 24 * 60 * 60 * 1000;

    if (this.selectedFilter === 'today') {
      list = list.filter(d => (now - d.createTime) < oneDayMs);
    } else if (this.selectedFilter === 'week') {
      list = list.filter(d => (now - d.createTime) < 7 * oneDayMs);
    } else if (this.selectedFilter === 'month') {
      list = list.filter(d => (now - d.createTime) < 30 * oneDayMs);
    }

    // æœç´¢è¿‡æ»¤
    if (this.searchText.trim()) {
      const keyword = this.searchText.toLowerCase();
      list = list.filter(d =>
      d.title.toLowerCase().includes(keyword) ||
      d.content.toLowerCase().includes(keyword)
      );
    }

    // é‡æ–°æŽ’åº:ç¡®ä¿ç½®é¡¶çš„åœ¨æœ€å‰é¢
    list.sort((a, b) => {
      if (a.isPinned && !b.isPinned) return -1;
      if (!a.isPinned && b.isPinned) return 1;
      return b.createTime - a.createTime;
    });

    this.filteredList = list;
  }

  navigateToDetail(diary?: Diary) {
    // FAB ç‚¹å‡»åŠ¨ç”»
    animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
      this.fabScale = 0.9;
    });
    setTimeout(() => {
      animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
        this.fabScale = 1.0;
      });
    }, 200);

    router.pushUrl({
      url: 'pages/DetailPage',
      params: { diary: diary ? diary.toJson() : null }
    });
  }

  async deleteDiary(diary: Diary, index: number) {
    try {
      await this.dataManager.deleteAudioFile(diary.audioPath);
      const actualIndex = this.diaryList.findIndex(d => d.id === diary.id);
      if (actualIndex >= 0) {
        this.diaryList.splice(actualIndex, 1);
      }
      await this.dataManager.saveDiaryList(this.diaryList);
      this.applyFilter();
      promptAction.showToast({ message: 'å·²åˆ é™¤' });
    } catch (error) {
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥' });
    }
  }

  async togglePin(diary: Diary) {
    try {
      diary.isPinned = !diary.isPinned;
      await this.dataManager.saveDiaryList(this.diaryList);
      await this.loadDiaryList();
      promptAction.showToast({
        message: diary.isPinned ? 'å·²ç½®é¡¶' : 'å·²å–æ¶ˆç½®é¡¶'
      });
    } catch (error) {
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥' });
    }
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      Column() {
        // 1. é¡¶éƒ¨æ ‡é¢˜æ  + æœç´¢æ 
        Column() {
          // æ ‡é¢˜è¡Œ
          Row() {
            Column() {
              Text('æˆ‘çš„')
                .fontSize(14)
                .fontColor('#999999')
              Text($r('app.string.voice_diary_title'))
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1E88E5')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            // æœç´¢æŒ‰é’®
            Button() {
              Image($r('app.media.icon'))
                .width(24)
                .height(24)
                .fillColor(this.showSearch ? '#1E88E5' : '#666666')
            }
            .width(44)
            .height(44)
            .type(ButtonType.Circle)
            .backgroundColor(this.showSearch ? '#E3F2FD' : Color.Transparent)
            .onClick(() => {
              animateTo({ duration: 300 }, () => {
                this.showSearch = !this.showSearch;
                if (!this.showSearch) {
                  this.searchText = '';
                  this.applyFilter();
                }
              });
            })
          }
          .width('100%')
          .padding({ left: 24, right: 24, top: 16, bottom: 12 })

          // æœç´¢æ¡†ï¼ˆåŠ¨ç”»å±•å¼€ï¼‰
          if (this.showSearch) {
            Row() {
              Image($r('app.media.icon'))
                .width(20)
                .height(20)
                .fillColor('#999999')
                .margin({ right: 8 })

              TextInput({ placeholder: 'æœç´¢æ—¥è®°...', text: this.searchText })
                .layoutWeight(1)
                .fontSize(16)
                .backgroundColor(Color.Transparent)
                .onChange((value: string) => {
                  this.searchText = value;
                  this.applyFilter();
                })

              if (this.searchText) {
                Button() {
                  Image($r('app.media.icon'))
                    .width(16)
                    .height(16)
                    .fillColor('#999999')
                }
                .width(28)
                .height(28)
                .type(ButtonType.Circle)
                .backgroundColor('#F0F0F0')
                .onClick(() => {
                  this.searchText = '';
                  this.applyFilter();
                })
              }
            }
            .width('90%')
            .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            .backgroundColor('#F5F5F5')
            .borderRadius(24)
            .margin({ left: 24, right: 24, bottom: 12 })
            .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: -20 } })
            .transition({ type: TransitionType.Delete, opacity: 0, translate: { y: -20 } })
          }

          // æ—¶é—´è¿‡æ»¤æ ‡ç­¾
          Row({ space: 12 }) {
            this.FilterChip('å…¨éƒ¨', 'all')
            this.FilterChip('ä»Šå¤©', 'today')
            this.FilterChip('æœ¬å‘¨', 'week')
            this.FilterChip('æœ¬æœˆ', 'month')
          }
          .width('100%')
          .padding({ left: 24, right: 24, bottom: 16 })
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .shadow({ radius: 4, color: 'rgba(0,0,0,0.06)', offsetY: 2 })

        // 2. æ—¥è®°åˆ—è¡¨
        if (this.filteredList.length === 0) {
          Column() {
            Image($r('app.media.icon'))
              .width(120)
              .height(120)
              .opacity(0.3)

            Text(this.searchText ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ—¥è®°' : $r('app.string.no_diary_yet'))
              .fontSize(16)
              .fontColor('#999999')
              .margin({ top: 24 })

            if (!this.searchText) {
              Text('ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®å¼€å§‹è®°å½•')
                .fontSize(14)
                .fontColor('#CCCCCC')
                .margin({ top: 8 })
            }
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#FAFAFA')
        } else {
          Column() {
            // ç»Ÿè®¡ä¿¡æ¯
            Row() {
              if (this.filteredList.filter(d => d.isPinned).length > 0) {
                Text(`ðŸ“Œ ${this.filteredList.filter(d => d.isPinned).length} æ¡ç½®é¡¶`)
                  .fontSize(12)
                  .fontColor('#757575')
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .backgroundColor('#EEEEEE')
                  .borderRadius(12)
                  .margin({ right: 12 })
              }
              Text(`å…± ${this.filteredList.length} æ¡è®°å½•`)
                .fontSize(14)
                .fontColor('#999999')
            }
            .width('100%')
            .padding({ left: 24, right: 24, top: 12, bottom: 8 })

            List({ space: 12 }) {
              ForEach(this.filteredList, (diary: Diary, index: number) => {
                ListItem() {
                  this.DiaryCard(diary)
                }
                .swipeAction({ end: this.swipeActions(diary, index) })
                .onClick(() => this.navigateToDetail(diary))
              }, (diary: Diary) => diary.id)
            }
            .width('100%')
            .layoutWeight(1)
            .padding({ left: 16, right: 16, bottom: 100 })
            .scrollBar(BarState.Off)
            .edgeEffect(EdgeEffect.Spring)
          }
          .layoutWeight(1)
          .backgroundColor('#FAFAFA')
        }
      }
      .width('100%')
      .height('100%')

      // 3. æ‚¬æµ®æ–°å»ºæŒ‰é’®ï¼ˆå¸¦è„‰å†²åŠ¨ç”»ï¼‰
      Stack() {
        // è„‰å†²å…‰æ™•
        Circle()
          .width(64)
          .height(64)
          .fill('rgba(30, 136, 229, 0.2)')
          .scale({ x: this.fabScale * 1.3, y: this.fabScale * 1.3 })

        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.icon'))
            .width(28)
            .height(28)
            .fillColor('#FFFFFF')
        }
        .width(64)
        .height(64)
        .backgroundColor('#1E88E5')
        .shadow({ radius: 12, color: 'rgba(30, 136, 229, 0.5)', offsetY: 6 })
        .scale({ x: this.fabScale, y: this.fabScale })
        .onClick(() => this.navigateToDetail())
      }
      .position({ x: '78%', y: '85%' })
      .zIndex(999)
      .onAppear(() => {
        // æŒç»­è„‰å†²åŠ¨ç”»
        setInterval(() => {
          animateTo({ duration: 1500, curve: Curve.EaseInOut }, () => {
            this.fabScale = 1.1;
          });
          setTimeout(() => {
            animateTo({ duration: 1500, curve: Curve.EaseInOut }, () => {
              this.fabScale = 1.0;
            });
          }, 1500);
        }, 3000);
      })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  FilterChip(label: string, value: string) {
    Text(label)
      .fontSize(14)
      .fontColor(this.selectedFilter === value ? '#FFFFFF' : '#666666')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor(this.selectedFilter === value ? '#1E88E5' : '#F0F0F0')
      .borderRadius(20)
      .onClick(() => {
        animateTo({ duration: 200 }, () => {
          this.selectedFilter = value;
        });
        this.applyFilter();
      })
  }

  @Builder
  DiaryCard(diary: Diary) {
    Column() {
      Row() {
        // å·¦ä¾§ï¼šæ—¥æœŸå—ï¼ˆæ¸å˜èƒŒæ™¯ï¼‰
        Column() {
          Text(new Date(diary.createTime).getDate().toString())
            .fontSize(26)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
          Text(`${new Date(diary.createTime).getMonth() + 1}æœˆ`)
            .fontSize(11)
            .fontColor('rgba(255,255,255,0.9)')
            .margin({ top: 2 })
        }
        .width(60)
        .height(60)
        .justifyContent(FlexAlign.Center)
        .linearGradient({
          angle: 135,
          colors: [[0x42A5F5, 0.0], [0x1E88E5, 1.0]]
        })
        .borderRadius(12)
        .margin({ right: 16 })

        // å³ä¾§ï¼šå†…å®¹
        Column() {
          Row() {
            // ç½®é¡¶æ ‡ç­¾
            if (diary.isPinned) {
              Row() {
                Image($r('app.media.icon'))
                  .width(12)
                  .height(12)
                  .fillColor('#FF9800')
                  .margin({ right: 4 })
                Text('ç½®é¡¶')
                  .fontSize(11)
                  .fontColor('#FF9800')
              }
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .backgroundColor('#FFF3E0')
              .borderRadius(4)
              .margin({ right: 8 })
            }

            Text(diary.title)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }
          .width('100%')

          Text(diary.getFormattedTime().split(' ')[1])
            .fontSize(12)
            .fontColor('#BBBBBB')
            .margin({ top: 6, bottom: 8 })

          Text(diary.getContentPreview(60))
            .fontSize(14)
            .fontColor('#666666')
            .lineHeight(22)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .border({
      width: diary.isPinned ? 2 : 0,
      color: diary.isPinned ? '#FFE0B2' : Color.Transparent
    })
    .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.06)', offsetY: 2 })
  }

  @Builder
  swipeActions(diary: Diary, index: number) {
    Row({ space: 4 }) {
      // ç½®é¡¶æŒ‰é’®
      Button() {
        Column() {
          Image($r('app.media.icon'))
            .width(20)
            .height(20)
            .fillColor('#FFFFFF')
          Text(diary.isPinned ? 'å–æ¶ˆ' : 'ç½®é¡¶')
            .fontSize(11)
            .fontColor('#FFFFFF')
            .margin({ top: 4 })
        }
      }
      .width(70)
      .height('100%')
      .backgroundColor('#FF9800')
      .type(ButtonType.Normal)
      .onClick(() => this.togglePin(diary))

      // åˆ é™¤æŒ‰é’®
      Button() {
        Column() {
          Image($r('app.media.icon'))
            .width(20)
            .height(20)
            .fillColor('#FFFFFF')
          Text('åˆ é™¤')
            .fontSize(11)
            .fontColor('#FFFFFF')
            .margin({ top: 4 })
        }
      }
      .width(70)
      .height('100%')
      .backgroundColor('#FF5252')
      .type(ButtonType.Normal)
      .onClick(() => this.deleteDiary(diary, index))
    }
    .height('100%')
  }
}