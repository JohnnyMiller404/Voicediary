import router from '@ohos.router';
import { Diary, DiaryJson } from '../model/DiaryModel';
import { DataManager } from '../manager/DataManager';
import { AudioManager, AudioCallbacks } from '../manager/AudioManager';
import { SpeechRecognizer } from '../manager/SpeechRecognizer';
import promptAction from '@ohos.promptAction';
import hilog from '@ohos.hilog';
import fs from '@ohos.file.fs';

@Entry
@Component
struct DetailPage {
  @State diary: Diary | null = null;
  @State isRecording: boolean = false;
  @State isPlaying: boolean = false;
  @State recognizedText: string = '';
  @State currentTime: string = '00:00';
  @State hasContent: boolean = false;
  @State showMenu: boolean = false;
  // åŠ¨ç”»çŠ¶æ€
  @State recordBtnScale: number = 1.0;
  @State rippleScale: number = 1.0;
  @State rippleOpacity: number = 0;
  @State waveAmplitude: number[] = [0.3, 0.5, 0.7, 0.5, 0.3, 0.6, 0.4, 0.8];
  @State audioProgress: number = 0; // 0-100
  // æ–°å¢ï¼šæƒ…ç»ªæ ‡ç­¾
  @State selectedMood: string = '';
  private moodOptions: string[] = ['ğŸ˜Š å¼€å¿ƒ', 'ğŸ˜¢ éš¾è¿‡', 'ğŸ˜¡ ç”Ÿæ°”', 'ğŸ˜Œ å¹³é™', 'ğŸ¤” æ€è€ƒ', 'ğŸ˜´ ç–²æƒ«'];
  private dataManager: DataManager = DataManager.getInstance();
  private audioManager: AudioManager = AudioManager.getInstance();
  private speechRecognizer: SpeechRecognizer = SpeechRecognizer.getInstance();
  private timerInterval: number = -1;
  private waveInterval: number = -1;
  private isRecognitionStarted: boolean = false;

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params['diary']) {
      this.diary = Diary.fromJson(params['diary'] as DiaryJson);
      if (this.diary) {
        this.recognizedText = this.diary.content;
        this.selectedMood = this.diary.mood || '';
        this.hasContent = true;
      }
    } else {
      this.hasContent = false;
    }
    this.initAllServices();
  }

  aboutToDisappear() {
    this.stopTimer();
    this.stopWaveAnimation();
    if (this.isRecording) {
      this.stopRecording().catch((err: Error) => {
      });
    }
  }

  async initAllServices() {
    await this.initAudioManager();
    try {
      const isSuccess = await this.speechRecognizer.initialize();
      if (isSuccess) {
        hilog.info(0x0000, 'DetailPage', 'è¯­éŸ³è¯†åˆ«æœåŠ¡å‡†å¤‡å°±ç»ª');
      }
    } catch (error) {
      if (error instanceof Error) {
        promptAction.showToast({ message: `è¯†åˆ«æœåŠ¡åˆå§‹åŒ–å¤±è´¥: ${error.message}` });
      }
    }
  }

  async initAudioManager() {
    try {
      await this.audioManager.initRecorder();
      await this.audioManager.initPlayer();
      const callbacks: AudioCallbacks = {
        onRecordStart: () => {
          this.isRecording = true;
          this.startTimer();
          this.startWaveAnimation();
          animateTo({ duration: 1000, iterations: -1, curve: Curve.EaseInOut }, () => {
            this.rippleScale = 1.5;
            this.rippleOpacity = 0.5;
          });
          if (!this.isRecognitionStarted) {
            this.startRecognitionAfterRecording();
          }
        },
        onRecordStop: (duration: number) => {
          this.isRecording = false;
          this.stopTimer();
          this.stopWaveAnimation();
          animateTo({ duration: 300 }, () => {
            this.rippleScale = 1.0;
            this.rippleOpacity = 0;
          });
          this.hasContent = true;
        },
        onPlayStart: () => {
          this.isPlaying = true;
          this.startAudioProgress();
        },
        onPlayComplete: () => {
          this.isPlaying = false;
          this.audioProgress = 0;
        },
        onError: (error: string) => {
          this.isRecording = false;
          this.isPlaying = false;
        },
        onPcmData: (data: ArrayBuffer) => {
          this.speechRecognizer.feedAudio(new Uint8Array(data));
        }
      };
      this.audioManager.setCallbacks(callbacks);
    } catch (error) {
      if (error instanceof Error) {
        promptAction.showToast({ message: `éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥: ${error.message}` });
      }
    }
  }

  private startRecognitionAfterRecording() {
    this.isRecognitionStarted = true;
    this.speechRecognizer.startRecognitionSession()
      .then(text => {
        this.recognizedText = text;
        if (this.diary) {
          this.diary.content = this.recognizedText;
          this.diary.title = Diary.generateTitle(this.recognizedText, this.diary.createTime);
        }
      })
      .catch((error: Error) => {
        this.recognizedText = `è¯­éŸ³è¯†åˆ«å¤±è´¥: ${error.message}`;
      });
  }

  async toggleRecording() {
    if (this.isRecording) {
      await this.stopRecording();
    } else {
      await this.startRecording();
    }
  }

  async startRecording() {
    if (this.isRecording) {
      return;
    }
    try {
      const diaryId = Date.now().toString();
      const audioPath = this.dataManager.getAudioFilePath(diaryId);
      this.diary = new Diary(diaryId, '', '', audioPath, Date.now());
      this.isRecognitionStarted = false;
      await this.audioManager.startRecording(audioPath);
    } catch (error) {
      this.isRecording = false;
    }
  }

  async stopRecording() {
    if (!this.isRecording) {
      return;
    }
    try {
      await this.audioManager.stopRecording();
      this.speechRecognizer.stopRecognitionSession();
      this.isRecognitionStarted = false;
    } catch (error) {
      this.speechRecognizer.stopRecognitionSession();
      this.isRecognitionStarted = false;
    }
  }

  async playAudio() {
    if (!this.diary?.audioPath) {
      return;
    }
    try {
      if (this.isPlaying) {
        await this.audioManager.stop();
      } else {
        await this.audioManager.play(this.diary.audioPath);
      }
    } catch (error) {
      if (error instanceof Error) {
        promptAction.showToast({ message: `æ’­æ”¾å¤±è´¥: ${error.message}` });
      }
    }
  }

  async saveDiary() {
    if (!this.diary || !this.recognizedText) {
      promptAction.showToast({ message: 'å†…å®¹ä¸ºç©º' });
      return;
    }
    try {
      this.diary.content = this.recognizedText;
      this.diary.mood = this.selectedMood;
      if (!this.diary.title) {
        this.diary.title = Diary.generateTitle(this.recognizedText, this.diary.createTime);
      }
      const diaryList = await this.dataManager.loadDiaryList();
      const existingIndex = diaryList.findIndex(d => d.id === this.diary!.id);
      if (existingIndex >= 0) {
        diaryList[existingIndex] = this.diary;
      } else {
        diaryList.push(this.diary);
      }
      await this.dataManager.saveDiaryList(diaryList);
      promptAction.showToast({ message: 'ä¿å­˜æˆåŠŸ' });
      setTimeout(() => router.back(), 500);
    } catch (error) {
      if (error instanceof Error) {
        promptAction.showToast({ message: `ä¿å­˜å¤±è´¥: ${error.message}` });
      }
    }
  }

  startTimer() {
    const startTime = Date.now();
    this.timerInterval = setInterval(() => {
      const elapsed = Date.now() - startTime;
      const seconds = Math.floor(elapsed / 1000);
      const minutes = Math.floor(seconds / 60);
      this.currentTime = `${String(minutes).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
    }, 1000);
  }

  stopTimer() {
    if (this.timerInterval >= 0) {
      clearInterval(this.timerInterval);
      this.timerInterval = -1;
      this.currentTime = '00:00';
    }
  }

  startWaveAnimation() {
    this.waveInterval = setInterval(() => {
      this.waveAmplitude = this.waveAmplitude.map(() => Math.random() * 0.8 + 0.2);
    }, 150);
  }

  stopWaveAnimation() {
    if (this.waveInterval >= 0) {
      clearInterval(this.waveInterval);
      this.waveInterval = -1;
    }
  }

  startAudioProgress() {
    // æ¨¡æ‹ŸéŸ³é¢‘è¿›åº¦ï¼ˆå®é™…åº”è¯¥ä» AudioManager è·å–ï¼‰
    const duration = 30000; // å‡è®¾30ç§’
    const interval = 100;
    const step = (interval / duration) * 100;

    const progressInterval = setInterval(() => {
      if (this.audioProgress >= 100 || !this.isPlaying) {
        clearInterval(progressInterval);
        this.audioProgress = 0;
      } else {
        this.audioProgress += step;
      }
    }, interval);
  }

  resetRecording() {
    AlertDialog.show({
      title: 'é‡æ–°å½•åˆ¶',
      message: 'é‡æ–°å½•åˆ¶å°†ä¸¢å¤±å½“å‰å†…å®¹,ç¡®å®šå—?',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
        }
      },
      secondaryButton: {
        value: 'ç¡®å®šé‡å½•',
        fontColor: '#FF5252',
        action: () => {
          this.hasContent = false;
          this.recognizedText = '';
          this.currentTime = '00:00';
          this.selectedMood = '';
        }
      }
    })
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ ï¼ˆæ¸å˜èƒŒæ™¯ï¼‰
      Row() {
        Button() {
          Image($r('app.media.icon'))
            .width(24).height(24)
            .fillColor('#FFFFFF')
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => router.back())

        Text(this.hasContent ? 'æ—¥è®°è¯¦æƒ…' : 'æ–°å»ºæ—¥è®°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        if (this.hasContent) {
          Button() {
            Image($r('app.media.icon'))
              .width(24).height(24)
              .fillColor('#FFFFFF')
          }
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showMenu = !this.showMenu;
          })
        } else {
          Blank().width(32)
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .linearGradient({
        angle: 135,
        colors: [[0x42A5F5, 0.0], [0x1E88E5, 1.0]]
      })
      .shadow({ radius: 8, color: 'rgba(30, 136, 229, 0.3)', offsetY: 4 })
      .zIndex(10)

      // èœå•å¼¹çª—
      if (this.showMenu) {
        Column() {
          Button('ä¿å­˜æ—¥è®°')
            .width('100%')
            .backgroundColor('#FFFFFF')
            .fontColor('#333333')
            .onClick(() => {
              this.showMenu = false;
              this.saveDiary();
            })

          Divider().color('#F0F0F0')

          Button('é‡æ–°å½•åˆ¶')
            .width('100%')
            .backgroundColor('#FFFFFF')
            .fontColor('#FF5252')
            .onClick(() => {
              this.showMenu = false;
              this.resetRecording();
            })
        }
        .width(150)
        .backgroundColor('#FFFFFF')
        .borderRadius(8)
        .position({ x: '75%', y: 60 })
        .shadow({ radius: 8, color: 'rgba(0,0,0,0.15)' })
        .zIndex(100)
        .padding(8)
      }

      // 2. ä¸»ä½“å†…å®¹
      Column() {
        if (!this.hasContent) {
          // ==================== å½•éŸ³ç•Œé¢ ====================
          Column() {
            Blank().layoutWeight(1)

            // å½•éŸ³çŠ¶æ€æç¤º
            Column() {
              Text(this.isRecording ? 'æ­£åœ¨å½•éŸ³ä¸­...' : 'è½»è§¦å¼€å§‹å½•éŸ³')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor(this.isRecording ? '#1E88E5' : '#999999')
                .margin({ bottom: 12 })

              if (this.isRecording) {
                Text('è¯´å‡ºä½ æƒ³è®°å½•çš„å†…å®¹')
                  .fontSize(14)
                  .fontColor('#BBBBBB')
              }
            }
            .margin({ bottom: 40 })

            // éŸ³é¢‘æ³¢å½¢å¯è§†åŒ–
            if (this.isRecording) {
              Row({ space: 4 }) {
                ForEach(this.waveAmplitude, (amplitude: number, index: number) => {
                  Rect()
                    .width(4)
                    .height(60 * amplitude)
                    .fill('#1E88E5')
                    .borderRadius(2)
                }, (item: number, index: number) => index.toString())
              }
              .height(60)
              .justifyContent(FlexAlign.Center)
              .margin({ bottom: 30 })
            }

            // å½•éŸ³æŒ‰é’®
            Stack() {
              if (this.isRecording) {
                Circle()
                  .width(140)
                  .height(140)
                  .fill('rgba(255, 82, 82, 0.2)')
                  .scale({ x: this.rippleScale, y: this.rippleScale })
                  .opacity(this.rippleOpacity)
              }

              Button({ type: ButtonType.Circle }) {
                Column() {
                  Image(this.isRecording ? $r('app.media.icon') : $r('app.media.icon'))
                    .width(this.isRecording ? 32 : 40)
                    .height(this.isRecording ? 32 : 40)
                    .fillColor('#FFFFFF')
                }
              }
              .width(120)
              .height(120)
              .backgroundColor(this.isRecording ? '#FF5252' : '#1E88E5')
              .shadow({
                radius: 12,
                color: this.isRecording ? 'rgba(255, 82, 82, 0.4)' : 'rgba(30, 136, 229, 0.4)',
                offsetY: 6
              })
              .scale({ x: this.recordBtnScale, y: this.recordBtnScale })
              .onClick(() => {
                animateTo({ duration: 150 }, () => {
                  this.recordBtnScale = 0.95;
                });
                setTimeout(() => {
                  animateTo({ duration: 150 }, () => {
                    this.recordBtnScale = 1.0;
                  });
                }, 150);
                this.toggleRecording();
              })
            }

            // è®¡æ—¶å™¨
            Text(this.currentTime)
              .fontSize(48)
              .fontWeight(FontWeight.Lighter)
              .fontColor(this.isRecording ? '#333333' : '#E0E0E0')
              .fontFamily('Monospace')
              .margin({ top: 50 })
              .transition({ type: TransitionType.All, opacity: 1 })

            Blank().layoutWeight(1)

            // æç¤ºæ–‡å­—
            if (!this.isRecording) {
              Text('ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³')
                .fontSize(14)
                .fontColor('#CCCCCC')
                .margin({ bottom: 40 })
            }
          }
          .width('100%')
          .height('100%')
          .linearGradient({
            angle: 180,
            colors: [[0xFAFAFA, 0.0], [0xF0F0F0, 1.0]]
          })

        } else {
          // ==================== è¯¦æƒ…ç•Œé¢ ====================
          Scroll() {
            Column() {
              // éŸ³é¢‘æ’­æ”¾å™¨
              if (this.diary?.audioPath) {
                Column() {
                  Row() {
                    Button({ type: ButtonType.Circle }) {
                      Image($r('app.media.icon'))
                        .width(24).height(24)
                        .fillColor('#FFFFFF')
                    }
                    .width(56)
                    .height(56)
                    .backgroundColor(this.isPlaying ? '#FF5252' : '#1E88E5')
                    .shadow({ radius: 8, color: 'rgba(30, 136, 229, 0.3)' })
                    .onClick(() => this.playAudio())

                    Column() {
                      Text(this.isPlaying ? 'æ’­æ”¾ä¸­...' : 'ç‚¹å‡»æ’­æ”¾å½•éŸ³')
                        .fontSize(16)
                        .fontColor('#333333')
                        .fontWeight(FontWeight.Medium)

                      // è¿›åº¦æ¡
                      Progress({ value: this.audioProgress, total: 100, type: ProgressType.Linear })
                        .width('100%')
                        .height(4)
                        .color('#1E88E5')
                        .margin({ top: 8 })
                    }
                    .margin({ left: 16 })
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Start)

                    if (!this.isRecognitionStarted) {
                      Button('é‡å½•')
                        .fontSize(14)
                        .fontColor('#FF5252')
                        .backgroundColor('#FFE5E5')
                        .padding({
                          left: 16,
                          right: 16,
                          top: 8,
                          bottom: 8
                        })
                        .borderRadius(20)
                        .onClick(() => this.resetRecording())
                    }
                  }
                  .width('100%')
                }
                .width('100%')
                .padding(20)
                .backgroundColor('#FFFFFF')
                .borderRadius(16)
                .margin({ bottom: 16 })
                .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetY: 2 })
              }

              // æƒ…ç»ªæ ‡ç­¾é€‰æ‹©
              Column() {
                Text('ä»Šå¤©çš„å¿ƒæƒ…')
                  .fontSize(14)
                  .fontColor('#999999')
                  .margin({ bottom: 12 })
                  .width('100%')
                Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
                  ForEach(this.moodOptions, (mood: string) => {
                    Text(mood)
                      .fontSize(14)
                      .padding({
                        left: 12,
                        right: 12,
                        top: 8,
                        bottom: 8
                      })
                      .backgroundColor(this.selectedMood === mood ? '#E3F2FD' : '#F5F5F5')
                      .fontColor(this.selectedMood === mood ? '#1E88E5' : '#666666')
                      .borderRadius(20)
                      .border({
                        width: this.selectedMood === mood ? 2 : 0,
                        color: '#1E88E5'
                      })
                      .onClick(() => {
                        animateTo({ duration: 200 }, () => {
                          this.selectedMood = mood;
                        });
                      })
                      .margin({ right: 12, bottom: 8 })
                  }, (mood: string) => mood)
                }
                .width('100%')
              }
              .width('100%')
              .padding(20)
              .backgroundColor('#FFFFFF')
              .borderRadius(16)
              .margin({ bottom: 16 })
              .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetY: 2 })

              // æ–‡æœ¬å†…å®¹
              Column() {
                Row() {
                  Text('å†…å®¹è¯¦æƒ…')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#333333')

                  Blank()

                  Text(`${this.recognizedText.length} å­—`)
                    .fontSize(12)
                    .fontColor('#999999')
                }
                .width('100%')
                .margin({ bottom: 16 })

                TextArea({ text: this.recognizedText })
                  .width('100%')
                  .height(450)
                  .fontSize(16)
                  .fontColor('#333333')
                  .lineHeight(28)
                  .padding(16)
                  .backgroundColor('#FAFAFA')
                  .borderRadius(12)
                  .onChange((value: string) => {
                    this.recognizedText = value;
                  })
              }
              .width('100%')
              .padding(20)
              .backgroundColor('#FFFFFF')
              .borderRadius(16)
              .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetY: 2 })

            }
            .padding(16)
          }
          .layoutWeight(1)
          .edgeEffect(EdgeEffect.Spring)
        }
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }
}